<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learning Dashboard - Adaptive Learning Agent</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Learning Dashboard</h1>
            <p class="subtitle" id="studentName">Loading...</p>
        </header>

        <main>
            <div id="loadingState" class="loading-state">
                <div class="loader"></div>
                <p>Loading your learning plan...</p>
            </div>

            <div id="dashboardContent" style="display: none;">
                <!-- Student Profile Section -->
                <div class="card">
                    <h2>Student Profile</h2>
                    <div class="profile-grid">
                        <div class="profile-item">
                            <span class="label">Name:</span>
                            <span class="value" id="profileName">-</span>
                        </div>
                        <div class="profile-item">
                            <span class="label">Class:</span>
                            <span class="value" id="profileClass">-</span>
                        </div>
                        <div class="profile-item">
                            <span class="label">Subject:</span>
                            <span class="value" id="profileSubject">-</span>
                        </div>
                        <div class="profile-item">
                            <span class="label">Goal:</span>
                            <span class="value" id="profileGoal">-</span>
                        </div>
                    </div>
                </div>

                <!-- Current Topic Section -->
                <div class="card">
                    <h2>Current Topic</h2>
                    <div class="topic-display">
                        <span class="topic-name" id="currentTopic">-</span>
                    </div>
                </div>

                <!-- Agent Action Section -->
                <div class="card">
                    <h2>Agent's Decision</h2>
                    <div class="action-display">
                        <span class="action-badge" id="agentAction">-</span>
                        <p class="action-description" id="actionDescription">The agent has analyzed your progress and made a decision.</p>
                    </div>
                </div>

                <!-- Today's Task Section -->
                <div class="card">
                    <h2>Today's Assigned Task</h2>
                    <div class="task-display">
                        <p id="taskContent">-</p>
                    </div>
                </div>

                <!-- Mastery Scores Section -->
                <div class="card">
                    <h2>Topic-wise Mastery</h2>
                    <div id="masteryContainer" class="mastery-container">
                        <p class="no-data">No mastery data available yet.</p>
                    </div>
                </div>

                <!-- Activity History Section -->
                <div class="card">
                    <h2>Activity History</h2>
                    <div id="activityContainer" class="activity-container">
                        <p class="no-data">No activity history available yet.</p>
                    </div>
                </div>

                <!-- Refresh Button -->
                <div class="card">
                    <button class="btn btn-primary" id="refreshBtn" onclick="loadDashboard()">
                        Refresh Dashboard
                    </button>
                </div>
            </div>

            <div id="errorState" class="error-state" style="display: none;">
                <div class="card">
                    <p class="error-message" id="errorText"></p>
                    <button class="btn btn-secondary" onclick="window.location.href='index.html'">Go Back to Onboarding</button>
                </div>
            </div>
        </main>
    </div>

    <script src="script.js"></script>
    <script>
        const studentId = localStorage.getItem('student_id');
        const studentName = localStorage.getItem('student_name');

        if (studentName) {
            document.getElementById('studentName').textContent = `Welcome, ${studentName}`;
        }

        if (!studentId) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('errorText').textContent = 'No student profile found. Please complete onboarding first.';
        } else {
            loadDashboard();
        }

        async function loadDashboard() {
            const loadingState = document.getElementById('loadingState');
            const dashboardContent = document.getElementById('dashboardContent');
            const errorState = document.getElementById('errorState');
            const refreshBtn = document.getElementById('refreshBtn');

            loadingState.style.display = 'block';
            dashboardContent.style.display = 'none';
            errorState.style.display = 'none';
            refreshBtn.disabled = true;

            try {
                // Fetch latest action from agent
                const latestActionResponse = await apiRequest(`/latest-action/${studentId}`, {
                    method: 'GET'
                });

                // Check if there's an error or no action yet
                if (latestActionResponse && latestActionResponse.error) {
                    throw new Error(latestActionResponse.error);
                }

                // Fetch mastery scores
                let masteryData = [];
                try {
                    const masteryResponse = await apiRequest(`/mastery/${studentId}`, {
                        method: 'GET'
                    });
                    masteryData = Array.isArray(masteryResponse) ? masteryResponse : [];
                } catch (e) {
                    console.warn('Could not fetch mastery data:', e);
                }

                // Handle case when no action exists yet
                if (latestActionResponse && latestActionResponse.message && latestActionResponse.action === null) {
                    // No action found - this is normal if Relay hasn't run yet
                    const action = 'PENDING';
                    const actionElement = document.getElementById('agentAction');
                    actionElement.textContent = action;
                    actionElement.className = 'action-badge action-pending';
                    document.getElementById('actionDescription').textContent = latestActionResponse.message || 'No agent decision available yet. Trigger the Relay workflow to generate your learning plan.';
                    document.getElementById('currentTopic').textContent = 'Not assigned yet';
                    document.getElementById('taskContent').textContent = 'No task assigned yet. Please trigger the Relay workflow for this student.';
                    latestActionResponse = null; // Set to null so we skip action processing
                }

                // Extract data from latest action
                const latestAction = (latestActionResponse && latestActionResponse.action !== null && latestActionResponse.action !== undefined) ? latestActionResponse : null;
                const action = latestAction ? (latestAction.action || 'PENDING') : 'PENDING';
                const result = latestAction ? (latestAction.result || '') : '';

                // Parse result (can be string or object)
                let task = 'No task assigned yet.';
                let topic = 'Not assigned yet';
                
                if (result) {
                    if (typeof result === 'string') {
                        task = result;
                    } else if (typeof result === 'object') {
                        task = result.task || result.content || JSON.stringify(result);
                        topic = result.topic || 'Not assigned yet';
                    }
                }
                
                // Only update action display if we have a real action
                if (latestAction) {

                // Populate agent action
                const actionElement = document.getElementById('agentAction');
                actionElement.textContent = action;
                actionElement.className = 'action-badge action-' + action.toLowerCase();

                // Action descriptions
                const descriptions = {
                    'REMEDIAL': 'The agent has identified areas that need reinforcement. Focus on building foundational understanding.',
                    'PRACTICE': 'The agent recommends practice exercises to strengthen your grasp of the current topic.',
                    'ADVANCE': 'The agent has determined you are ready to move to the next topic.',
                    'PENDING': latestActionResponse && latestActionResponse.message ? latestActionResponse.message : 'No agent decision available yet. Trigger the Relay workflow to generate your learning plan.'
                };
                document.getElementById('actionDescription').textContent = descriptions[action] || descriptions['PENDING'];

                // Populate current topic and task
                document.getElementById('currentTopic').textContent = topic;
                document.getElementById('taskContent').textContent = task;
                }

                // Populate student profile (from localStorage or latestAction if available)
                const storedName = localStorage.getItem('student_name') || '-';
                document.getElementById('profileName').textContent = storedName;
                
                // Try to get more student info if available in action
                if (latestAction && latestAction.student) {
                    document.getElementById('profileClass').textContent = latestAction.student.class_level || '-';
                    document.getElementById('profileSubject').textContent = latestAction.student.subject || '-';
                    document.getElementById('profileGoal').textContent = latestAction.student.goal || '-';
                }

                // Populate mastery scores
                const masteryContainer = document.getElementById('masteryContainer');
                if (masteryData && masteryData.length > 0) {
                    masteryContainer.innerHTML = '';
                    masteryData.forEach(item => {
                        const masteryItem = document.createElement('div');
                        masteryItem.className = 'mastery-item';
                        
                        const topicName = document.createElement('div');
                        topicName.className = 'mastery-topic';
                        topicName.textContent = item.topic || item.topic_name || 'Unknown Topic';
                        
                        const scoreBar = document.createElement('div');
                        scoreBar.className = 'mastery-score-bar';
                        
                        const scoreFill = document.createElement('div');
                        scoreFill.className = 'mastery-score-fill';
                        const score = parseInt(item.score || item.mastery_score || 0);
                        scoreFill.style.width = `${score}%`;
                        scoreFill.textContent = `${score}%`;
                        
                        scoreBar.appendChild(scoreFill);
                        masteryItem.appendChild(topicName);
                        masteryItem.appendChild(scoreBar);
                        masteryContainer.appendChild(masteryItem);
                    });
                } else {
                    masteryContainer.innerHTML = '<p class="no-data">No mastery data available yet. The agent will generate this after analyzing your progress.</p>';
                }

                // Populate activity history
                const activityContainer = document.getElementById('activityContainer');
                if (latestAction) {
                    activityContainer.innerHTML = '';
                    const activityItem = document.createElement('div');
                    activityItem.className = 'activity-item';
                    
                    const activityText = `${action}: ${task}`;
                    const timestamp = latestAction.created_at ? formatDate(latestAction.created_at) : '';
                    
                    activityItem.innerHTML = `
                        <span class="activity-number">1</span>
                        <span class="activity-text">${activityText}</span>
                        ${timestamp ? `<span class="activity-time">${timestamp}</span>` : ''}
                    `;
                    
                    activityContainer.appendChild(activityItem);
                } else {
                    activityContainer.innerHTML = '<p class="no-data">No activity history available yet. Trigger the Relay workflow to generate your learning plan.</p>';
                }

                loadingState.style.display = 'none';
                dashboardContent.style.display = 'block';
                refreshBtn.disabled = false;
            } catch (error) {
                loadingState.style.display = 'none';
                errorState.style.display = 'block';
                document.getElementById('errorText').textContent = 'Failed to load dashboard: ' + error.message + '. Make sure the Relay workflow has been triggered for this student.';
                refreshBtn.disabled = false;
            }
        }
    </script>
</body>
</html>
